<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-30867542-2"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-30867542-2', {
              page_path: window.location.pathname,
            });
          </script><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1, minimum-scale=1" name="viewport"/><link rel="icon" href="/images/notsobad/favicon.ico"/><meta name="description" content="ぼっちスタートアップが日々がんばっています。"/><meta content="website" property="og:type"/><meta content="https://blog.notsobad.jp/images/notsobad/ogp.png" property="og:image"/><meta content="NOT SO BADなブログ" property="og:site_name"/><meta content="summary_large_image" name="twitter:card"/><meta content="https://blog.notsobad.jp/images/notsobad/ogp.png" name="twitter:image:src"/><title>Riot.js x Firebaseで作る、超お手軽なパスワード不要のログインシステム「Magic Login」</title><meta content="Riot.js x Firebaseで作る、超お手軽なパスワード不要のログインシステム「Magic Login」" property="og:title"/><meta content="https://notsobad.jp/blog/2016/12/28/Riot_x_Firebaseで作る、超お手軽なパスワード不要のログイン" property="og:url"/><link rel="canonical" href="https://blog.notsobad.jp/2016/12/28/Riot_x_Firebaseで作る、超お手軽なパスワード不要のログイン"/><meta content="(2018年8月追記)  
現在この機能はfirebase公式で提供されています。  
このブログの実装方法もまだ使えますが、簡単なのでぜひ公式のをお使いください。  
[JavaScript でメールリンクを使用して Firebase 認証を行う  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth?hl=ja)  
(追記終わり)

* * *

Webサービスで本当にパスワードっているの？？という意識高いスタンスから、  
むかしQiitaにRailsでパスワードなしログインの実装について記事を書きました。

&lt;iframe src=&quot;https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F832dbd6c1a0a012519fd&quot; title=&quot;【Rails × sorcery】Slackみたいなパスワードなしのメールだけログイン機能を実装してみる - Qiita&quot; class=&quot;embed-card embed-webcard&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; style=&quot;display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;&quot;&gt;&lt;/iframe&gt;&lt;cite class=&quot;hatena-citation&quot;&gt;&lt;a href=&quot;http://qiita.com/tomomichi/items/832dbd6c1a0a012519fd&quot;&gt;qiita.com&lt;/a&gt;&lt;/cite&gt;

完全に使うあてもなく趣味で作った機能だったけど、 本体のSorceryにプルリク送ったらかなり歓迎されて、 あとはテストさえ書けば取り込んでもらえそうな状態です。  
（じゃあ書けよっていう。。）

[Add Magic Login submodule by athix · Pull Request #8 · Sorcery/sorcery · GitHub](https://github.com/Sorcery/sorcery/pull/8)

しかし最近はFirebaseがマイブームなので、Firebase版のパスワードなしログインシステム「Magic Login」を実装してみました。

Firebaseには匿名認証の仕組みもあるので、ユーザー登録なしでも使えて、本登録するときは「MagicLogin」という組み合わせにすると、かなりいい感じになりましたよと。" property="og:description"/><meta content="Riot.js x Firebaseで作る、超お手軽なパスワード不要のログインシステム「Magic Login」" name="twitter:title"/><meta content="(2018年8月追記)  
現在この機能はfirebase公式で提供されています。  
このブログの実装方法もまだ使えますが、簡単なのでぜひ公式のをお使いください。  
[JavaScript でメールリンクを使用して Firebase 認証を行う  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth?hl=ja)  
(追記終わり)

* * *

Webサービスで本当にパスワードっているの？？という意識高いスタンスから、  
むかしQiitaにRailsでパスワードなしログインの実装について記事を書きました。

&lt;iframe src=&quot;https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F832dbd6c1a0a012519fd&quot; title=&quot;【Rails × sorcery】Slackみたいなパスワードなしのメールだけログイン機能を実装してみる - Qiita&quot; class=&quot;embed-card embed-webcard&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; style=&quot;display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;&quot;&gt;&lt;/iframe&gt;&lt;cite class=&quot;hatena-citation&quot;&gt;&lt;a href=&quot;http://qiita.com/tomomichi/items/832dbd6c1a0a012519fd&quot;&gt;qiita.com&lt;/a&gt;&lt;/cite&gt;

完全に使うあてもなく趣味で作った機能だったけど、 本体のSorceryにプルリク送ったらかなり歓迎されて、 あとはテストさえ書けば取り込んでもらえそうな状態です。  
（じゃあ書けよっていう。。）

[Add Magic Login submodule by athix · Pull Request #8 · Sorcery/sorcery · GitHub](https://github.com/Sorcery/sorcery/pull/8)

しかし最近はFirebaseがマイブームなので、Firebase版のパスワードなしログインシステム「Magic Login」を実装してみました。

Firebaseには匿名認証の仕組みもあるので、ユーザー登録なしでも使えて、本登録するときは「MagicLogin」という組み合わせにすると、かなりいい感じになりましたよと。" name="twitter:description"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/c3886bc2332f249800be.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c3886bc2332f249800be.css"/><link rel="preload" href="/_next/static/4vVtrTBQuk15W6qLTMkec/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/4vVtrTBQuk15W6qLTMkec/pages/entry/%5B...slug%5D.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-c212667a5f965e81e004.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.4dd1003cc9c949c7fcd3.js" as="script"/><link rel="preload" href="/_next/static/chunks/91571cffe5955e319562449996bfe57dbd3e0d38.638a41a739461475fef6.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-21a6ccde974ffcb2250f.js" as="script"/><link rel="preload" href="/_next/static/chunks/f00e1974e9e34e095fc8d755f480321b19c7b23c.840c216a28f4aceb35cf.js" as="script"/><link rel="preload" href="/_next/static/chunks/b986732da9185a1f87bded4986a5845469ee7feb.7cfb4410e6422c3e9136.js" as="script"/></head><body><div id="__next"><div><section class="text-gray-700 body-font"><div class="container px-5 md:px-24 p-5 md:pb-12 mx-auto max-w-screen-lg"><h1 class="text-xl font-bold title-font text-gray-900 mb-4 inline-block border-b-4 border-gray-900"><a href="/">NOT SO BAD なブログ</a></h1><h2 class="text-xs text-gray-700 tracking-widest font-medium title-font">ぼっちスタートアップが日々がんばっています。</h2></div></section><section class="text-gray-700 body-font overflow-hidden break-all"><div class="container px-5 md:px-24 pb-24 mx-auto max-w-screen-lg"><div class="-my-8"><div class="py-12 flex flex-wrap md:flex-no-wrap"><div class="md:w-64 md:mb-0 mb-6 flex-shrink-0 flex flex-col"><span class="mt-1 text-gray-900 font-bold">2016-12-28</span></div><div class="flex-grow"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 title-font mb-4">Riot.js x Firebaseで作る、超お手軽なパスワード不要のログインシステム「Magic Login」</h2><div class="mb-4"><a href="/tag/つくったもの"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">つくったもの</span></a><a href="/tag/技術系"><span class="bg-gray-200 px-2 py-1 mr-2 text-sm rounded-md">技術系</span></a></div><div id="mainText" class="leading-relaxed"><p class="my-6">(2018年8月追記)<br/>現在この機能はfirebase公式で提供されています。<br/>このブログの実装方法もまだ使えますが、簡単なのでぜひ公式のをお使いください。<br/><a href="https://firebase.google.com/docs/auth/web/email-link-auth?hl=ja" target="_blank" class="text-blue-600 underline">JavaScript でメールリンクを使用して Firebase 認証を行う  |  Firebase</a><br/>(追記終わり)</p><hr/><p class="my-6">Webサービスで本当にパスワードっているの？？という意識高いスタンスから、<br/>むかしQiitaにRailsでパスワードなしログインの実装について記事を書きました。</p><span><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F832dbd6c1a0a012519fd" title="【Rails × sorcery】Slackみたいなパスワードなしのメールだけログイン機能を実装してみる - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://qiita.com/tomomichi/items/832dbd6c1a0a012519fd">qiita.com</a></cite></span><p class="my-6">完全に使うあてもなく趣味で作った機能だったけど、 本体のSorceryにプルリク送ったらかなり歓迎されて、 あとはテストさえ書けば取り込んでもらえそうな状態です。<br/>（じゃあ書けよっていう。。）</p><p class="my-6"><a href="https://github.com/Sorcery/sorcery/pull/8" target="_blank" class="text-blue-600 underline">Add Magic Login submodule by athix · Pull Request #8 · Sorcery/sorcery · GitHub</a></p><p class="my-6">しかし最近はFirebaseがマイブームなので、Firebase版のパスワードなしログインシステム「Magic Login」を実装してみました。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">Firebaseには匿名認証の仕組みもあるので、ユーザー登録なしでも使えて、本登録するときは「MagicLogin」という組み合わせにすると、かなりいい感じになりましたよと。環境</h2><ul class="text-left list-disc ml-6"><li class="leading-8">Firebase: 3.5.0</li><li class="leading-8">Riot.js: 3.0.0</li><li class="leading-8">SemanticUI: 2.2.4</li></ul><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">Firebase x Riot.jsのセットアップ</h2><p class="my-6">この2つを使ったシステムのセットアップについては、<br/>むかしQiitaに記事書きましたのでこちらを参考にしてください。</p><span><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F43da4d35007e69d0f484" title="【Riot.js v3対応】Riot.js x Firebase で超お手軽にWebアプリを作ってみる - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://qiita.com/tomomichi/items/43da4d35007e69d0f484">qiita.com</a></cite></span><p class="my-6">以下この記事の内容をベースに追加修正していきます。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">実装方針</h2><ul class="text-left list-disc ml-6"><li class="leading-8">サイトに訪問したら自動で匿名ユーザーとしてログインさせる</li><li class="leading-8">メアドを入力したら、そのアドレスにトークン付きのワンタイムログインリンクを送る</li><li class="leading-8">リンクを踏んで来たらログインさせる</li><li class="leading-8">匿名ユーザーで作成してたデータを本ユーザーアカウントに紐づける（今回は省略）</li></ul><p class="my-6">こんな感じ。</p><p class="my-6">今回はユーザーが新規登録かログインかを意識せずに使えるように設計してみました。</p><p class="my-6">メアド入れたときに、既登録ならそのままログインリンクを送り、未登録なら新規登録した上でログインリンクを送る、という感じにしています。</p><p class="my-6">新規登録とログインの間違えってけっこう多いし、そんなんシステムで判断してくれよ、って個人的には思うのですよね。。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">ログイン画面</h2><h3 class="font-bold inline-block my-4 md:my-8 text-xl">完成イメージ</h3><p class="my-6">こんな感じの見た目にしていきます。</p><p class="my-6">Slackのメールだけログイン画面にあからさまに影響を受けた、メールと魔法の杖のアイコンがすてきです。</p><p class="my-6">なんとこれ、画像一切つかわずやってるってなかなかすごくないですか。<br/>SemanticUIのアイコン合成機能です。Semanticすごい！</p><h3 class="font-bold inline-block my-4 md:my-8 text-xl">実装</h3><p class="my-6">auth.tagをこんな感じで実装。</p><div><auth>
  <div class="ui padded basic segment">
    <br><br>
    <div class="ui three column center aligned stackable grid">
      <div class="ui column">
        <div class="ui center aligned basic segment">
            <i class="icons">
              <i class="purple inverted mail circular huge icon"></i>
              <i class="horizontally flipped wizard huge icon"></i>
            </i>
            <h1 class="ui header">
              Magic Login
              <div class="sub header">
                Get a magic linked email for super easy sign-in;)
              </div>
            </h1>
          <div class="ui action fluid input">
            <input type="text" ref="email" placeholder="Type your email here.">
            <button class="ui pink right labeled icon button" onclick={ magicAuth }>
              <i class="send icon"></i>
              Send
            </button>
          </div>
          <div if={ message } class="ui visible left aligned basic segment { message.type } message">{ message.text }</div>
        </div>
      </div>
    </div>
    <br><br>
  </div></div><div>  <script>
    var that = this

    firebase.auth().onAuthStateChanged(function(user) {
      that.user = user
    })

    magicAuth() {
      that.errorMessage = ''
      var newPassword = Math.random().toString(36).slice(-12)

      firebase.auth().createUserWithEmailAndPassword(that.refs.email.value, newPassword).then(function(){
        //新規ユーザーの場合
        firebase.auth().sendPasswordResetEmail(that.refs.email.value)
        firebase.auth().signOut()
        that.message = {
          type: 'success',
          text: 'ログイン用のメールを送信しました。メール内のリンクをクリックしてログインしてください。'
        }
      }).catch(function(error) {
        //アドレスが既に登録済みの場合
        if(error.code == 'auth/email-already-in-use') {
          firebase.auth().sendPasswordResetEmail(that.refs.email.value)
          that.message = {
            type: 'success',
            text: 'ログイン用のメールを送信しました。メール内のリンクをクリックしてログインしてください。'
          }
        //validationエラーなど
        }else {
          that.message = {
            type: 'error',
            text: error.message
          }
        }
      }).then(function(){
        that.update()
      })
    }
  </script></div><span></auth></span><p class="my-6">キモは<code>firebase.auth().sendPasswordResetEmail(that.refs.email.value)</code>の部分で、要するにパスワードリセットメールを送ってるのですね。</p><p class="my-6">これを踏んだあとの処理を魔改造することで、マジックログインを超簡単に実装しています。<br/>次はそっちを見てみましょう。</p><h3 class="font-bold inline-block my-4 md:my-8 text-xl">リンク踏んだあとの処理</h3><p class="my-6">riot.jsのroutingで、ログインメールのリンク踏んだときの処理を受け付けています。</p><pre><code>route(&#x27;/auth..&#x27;, function(){
  var q = route.query()
  if(q.mode == &#x27;resetPassword&#x27;) {
    firebase.auth().verifyPasswordResetCode(q.oobCode).then(function(email) {
      var newPassword = Math.random().toString(36).slice(-12)
      firebase.auth().confirmPasswordReset(q.oobCode, newPassword).then(function(){
        firebase.auth().signInWithEmailAndPassword(email, newPassword)
        alert(&#x27;ログインしました&#x27;)
      })
    }).catch(function(error){
      alert(&#x27;ログインに失敗しました..&#x27;)
    })
  }
})</code></pre><p class="my-6"><code>auth?mode=resetPassword&amp;oobCode=xxxxxx</code>という感じのURLを踏んでくるイメージです。<br/>（パラメータはFirebaseが自動付与）</p><p class="my-6">やってることは、</p><ul class="text-left list-disc ml-6"><li class="leading-8"><code>verifyPasswordResetCode(q.oobCode)</code>でトークンの検証</li><li class="leading-8">正しいトークンならランダムに生成した文字列を新パスワードに設定</li><li class="leading-8">新パスワードでログイン</li></ul><p class="my-6">というだけです。</p><p class="my-6">キモは新パスワードをユーザーが意識することはないし、システム側でも管理しないというところ。超セキュア！</p><p class="my-6">次ログインするときはまたリセットするだけですからね。</p><h3 class="font-bold inline-block my-4 md:my-8 text-xl">Firebaseの設定</h3><p class="my-6">Firebase側では、ログインメール（＝パスワードリセットメール）のリンクURLを設定しておきます。</p><p class="my-6">Consoleで、</p><blockquote><p class="my-6">Authentication &gt; メールテンプレート &gt; パスワードの再設定</p></blockquote><p class="my-6">から設定を編集し、「アクションURLをカスタマイズ」というメニューで好きなURLを設定しておきます。</p><blockquote><p class="my-6"><code>https://hogehoge.com/auth</code></p></blockquote><p class="my-6">こんな感じで設定しておけば、パラメータ部分はFirebaseが自動で付与してくれます。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">まとめ</h2><p class="my-6">というわけで、Firebaseの標準機能に乗っかることで超お手軽にMagicLoginが実装できました。</p><p class="my-6">この記事では触れなかったけど、アクセス時に全員匿名ユーザーとして裏でログインさせておいて、 データを永続化したいときはこの仕組みで簡単ログイン、という組み合わせにするとかなりいい感じです。</p><p class="my-6">このサービスで実践投入してますので、よければどんな感じか見てみてください。</p><span><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-timeline.jp%2F" title="簡単・便利な無料の年表作成サービス | THE TIMELINE(ザ・タイムライン)" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://the-timeline.jp/">the-timeline.jp</a></cite></span><p class="my-6">年表たのしいでよ。</p></div></div></div></div></div></section><footer class="text-gray-200 body-font"><div class="bg-gray-900"><div class="container mx-auto py-6 px-5 md:px-24 flex flex-wrap flex-col sm:flex-row max-w-screen-lg"><p class="text-gray-200 text-sm text-center sm:text-left"><a class="text-gray-500 hover:text-gray-200 ml-1" href="/">© 2020 NOT SO BADなブログ</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"title":"Riot.js x Firebaseで作る、超お手軽なパスワード不要のログインシステム「Magic Login」","slug":"2016/12/28/Riot_x_Firebaseで作る、超お手軽なパスワード不要のログイン","excerpt":"(2018年8月追記)  \n現在この機能はfirebase公式で提供されています。  \nこのブログの実装方法もまだ使えますが、簡単なのでぜひ公式のをお使いください。  \n[JavaScript でメールリンクを使用して Firebase 認証を行う  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth?hl=ja)  \n(追記終わり)\n\n* * *\n\nWebサービスで本当にパスワードっているの？？という意識高いスタンスから、  \nむかしQiitaにRailsでパスワードなしログインの実装について記事を書きました。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F832dbd6c1a0a012519fd\" title=\"【Rails × sorcery】Slackみたいなパスワードなしのメールだけログイン機能を実装してみる - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://qiita.com/tomomichi/items/832dbd6c1a0a012519fd\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\n\n完全に使うあてもなく趣味で作った機能だったけど、 本体のSorceryにプルリク送ったらかなり歓迎されて、 あとはテストさえ書けば取り込んでもらえそうな状態です。  \n（じゃあ書けよっていう。。）\n\n[Add Magic Login submodule by athix · Pull Request #8 · Sorcery/sorcery · GitHub](https://github.com/Sorcery/sorcery/pull/8)\n\nしかし最近はFirebaseがマイブームなので、Firebase版のパスワードなしログインシステム「Magic Login」を実装してみました。\n\nFirebaseには匿名認証の仕組みもあるので、ユーザー登録なしでも使えて、本登録するときは「MagicLogin」という組み合わせにすると、かなりいい感じになりましたよと。","content":"(2018年8月追記)  \n現在この機能はfirebase公式で提供されています。  \nこのブログの実装方法もまだ使えますが、簡単なのでぜひ公式のをお使いください。  \n[JavaScript でメールリンクを使用して Firebase 認証を行う  |  Firebase](https://firebase.google.com/docs/auth/web/email-link-auth?hl=ja)  \n(追記終わり)\n\n* * *\n\nWebサービスで本当にパスワードっているの？？という意識高いスタンスから、  \nむかしQiitaにRailsでパスワードなしログインの実装について記事を書きました。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F832dbd6c1a0a012519fd\" title=\"【Rails × sorcery】Slackみたいなパスワードなしのメールだけログイン機能を実装してみる - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://qiita.com/tomomichi/items/832dbd6c1a0a012519fd\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\n\n完全に使うあてもなく趣味で作った機能だったけど、 本体のSorceryにプルリク送ったらかなり歓迎されて、 あとはテストさえ書けば取り込んでもらえそうな状態です。  \n（じゃあ書けよっていう。。）\n\n[Add Magic Login submodule by athix · Pull Request #8 · Sorcery/sorcery · GitHub](https://github.com/Sorcery/sorcery/pull/8)\n\nしかし最近はFirebaseがマイブームなので、Firebase版のパスワードなしログインシステム「Magic Login」を実装してみました。\n\nFirebaseには匿名認証の仕組みもあるので、ユーザー登録なしでも使えて、本登録するときは「MagicLogin」という組み合わせにすると、かなりいい感じになりましたよと。環境\n--\n\n*   Firebase: 3.5.0\n*   Riot.js: 3.0.0\n*   SemanticUI: 2.2.4\n\nFirebase x Riot.jsのセットアップ\n-------------------------\n\nこの2つを使ったシステムのセットアップについては、  \nむかしQiitaに記事書きましたのでこちらを参考にしてください。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fqiita.com%2Ftomomichi%2Fitems%2F43da4d35007e69d0f484\" title=\"【Riot.js v3対応】Riot.js x Firebase で超お手軽にWebアプリを作ってみる - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://qiita.com/tomomichi/items/43da4d35007e69d0f484\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\n\n以下この記事の内容をベースに追加修正していきます。\n\n実装方針\n----\n\n*   サイトに訪問したら自動で匿名ユーザーとしてログインさせる\n*   メアドを入力したら、そのアドレスにトークン付きのワンタイムログインリンクを送る\n*   リンクを踏んで来たらログインさせる\n*   匿名ユーザーで作成してたデータを本ユーザーアカウントに紐づける（今回は省略）\n\nこんな感じ。\n\n今回はユーザーが新規登録かログインかを意識せずに使えるように設計してみました。\n\nメアド入れたときに、既登録ならそのままログインリンクを送り、未登録なら新規登録した上でログインリンクを送る、という感じにしています。\n\n新規登録とログインの間違えってけっこう多いし、そんなんシステムで判断してくれよ、って個人的には思うのですよね。。\n\nログイン画面\n------\n\n### 完成イメージ\n\nこんな感じの見た目にしていきます。\n\n![f:id:o_tomomichi:20161228105538p:plain](https://storage.googleapis.com/blog-notsobad/images/20161228105538.png \"f:id:o_tomomichi:20161228105538p:plain\")\n\nSlackのメールだけログイン画面にあからさまに影響を受けた、メールと魔法の杖のアイコンがすてきです。\n\nなんとこれ、画像一切つかわずやってるってなかなかすごくないですか。  \nSemanticUIのアイコン合成機能です。Semanticすごい！\n\n### 実装\n\nauth.tagをこんな感じで実装。\n\n\u003cauth\u003e\n  \u003cdiv class=\"ui padded basic segment\"\u003e\n    \u003cbr\u003e\u003cbr\u003e\n    \u003cdiv class=\"ui three column center aligned stackable grid\"\u003e\n      \u003cdiv class=\"ui column\"\u003e\n        \u003cdiv class=\"ui center aligned basic segment\"\u003e\n            \u003ci class=\"icons\"\u003e\n              \u003ci class=\"purple inverted mail circular huge icon\"\u003e\u003c/i\u003e\n              \u003ci class=\"horizontally flipped wizard huge icon\"\u003e\u003c/i\u003e\n            \u003c/i\u003e\n            \u003ch1 class=\"ui header\"\u003e\n              Magic Login\n              \u003cdiv class=\"sub header\"\u003e\n                Get a magic linked email for super easy sign-in;)\n              \u003c/div\u003e\n            \u003c/h1\u003e\n          \u003cdiv class=\"ui action fluid input\"\u003e\n            \u003cinput type=\"text\" ref=\"email\" placeholder=\"Type your email here.\"\u003e\n            \u003cbutton class=\"ui pink right labeled icon button\" onclick={ magicAuth }\u003e\n              \u003ci class=\"send icon\"\u003e\u003c/i\u003e\n              Send\n            \u003c/button\u003e\n          \u003c/div\u003e\n          \u003cdiv if={ message } class=\"ui visible left aligned basic segment { message.type } message\"\u003e{ message.text }\u003c/div\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n    \u003c/div\u003e\n    \u003cbr\u003e\u003cbr\u003e\n  \u003c/div\u003e\n\n\n  \u003cscript\u003e\n    var that = this\n\n    firebase.auth().onAuthStateChanged(function(user) {\n      that.user = user\n    })\n\n    magicAuth() {\n      that.errorMessage = ''\n      var newPassword = Math.random().toString(36).slice(-12)\n\n      firebase.auth().createUserWithEmailAndPassword(that.refs.email.value, newPassword).then(function(){\n        //新規ユーザーの場合\n        firebase.auth().sendPasswordResetEmail(that.refs.email.value)\n        firebase.auth().signOut()\n        that.message = {\n          type: 'success',\n          text: 'ログイン用のメールを送信しました。メール内のリンクをクリックしてログインしてください。'\n        }\n      }).catch(function(error) {\n        //アドレスが既に登録済みの場合\n        if(error.code == 'auth/email-already-in-use') {\n          firebase.auth().sendPasswordResetEmail(that.refs.email.value)\n          that.message = {\n            type: 'success',\n            text: 'ログイン用のメールを送信しました。メール内のリンクをクリックしてログインしてください。'\n          }\n        //validationエラーなど\n        }else {\n          that.message = {\n            type: 'error',\n            text: error.message\n          }\n        }\n      }).then(function(){\n        that.update()\n      })\n    }\n  \u003c/script\u003e\n\u003c/auth\u003e\n\nキモは`firebase.auth().sendPasswordResetEmail(that.refs.email.value)`の部分で、要するにパスワードリセットメールを送ってるのですね。\n\nこれを踏んだあとの処理を魔改造することで、マジックログインを超簡単に実装しています。  \n次はそっちを見てみましょう。\n\n### リンク踏んだあとの処理\n\nriot.jsのroutingで、ログインメールのリンク踏んだときの処理を受け付けています。\n\n    route('/auth..', function(){\n      var q = route.query()\n      if(q.mode == 'resetPassword') {\n        firebase.auth().verifyPasswordResetCode(q.oobCode).then(function(email) {\n          var newPassword = Math.random().toString(36).slice(-12)\n          firebase.auth().confirmPasswordReset(q.oobCode, newPassword).then(function(){\n            firebase.auth().signInWithEmailAndPassword(email, newPassword)\n            alert('ログインしました')\n          })\n        }).catch(function(error){\n          alert('ログインに失敗しました..')\n        })\n      }\n    })\n\n`auth?mode=resetPassword\u0026oobCode=xxxxxx`という感じのURLを踏んでくるイメージです。  \n（パラメータはFirebaseが自動付与）\n\nやってることは、\n\n*   `verifyPasswordResetCode(q.oobCode)`でトークンの検証\n*   正しいトークンならランダムに生成した文字列を新パスワードに設定\n*   新パスワードでログイン\n\nというだけです。\n\nキモは新パスワードをユーザーが意識することはないし、システム側でも管理しないというところ。超セキュア！\n\n次ログインするときはまたリセットするだけですからね。\n\n### Firebaseの設定\n\nFirebase側では、ログインメール（＝パスワードリセットメール）のリンクURLを設定しておきます。\n\nConsoleで、\n\n\u003e Authentication \u003e メールテンプレート \u003e パスワードの再設定\n\nから設定を編集し、「アクションURLをカスタマイズ」というメニューで好きなURLを設定しておきます。\n\n\u003e `https://hogehoge.com/auth`\n\nこんな感じで設定しておけば、パラメータ部分はFirebaseが自動で付与してくれます。\n\nまとめ\n---\n\nというわけで、Firebaseの標準機能に乗っかることで超お手軽にMagicLoginが実装できました。\n\nこの記事では触れなかったけど、アクセス時に全員匿名ユーザーとして裏でログインさせておいて、 データを永続化したいときはこの仕組みで簡単ログイン、という組み合わせにするとかなりいい感じです。\n\nこのサービスで実践投入してますので、よければどんな感じか見てみてください。\n\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fthe-timeline.jp%2F\" title=\"簡単・便利な無料の年表作成サービス | THE TIMELINE(ザ・タイムライン)\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://the-timeline.jp/\"\u003ethe-timeline.jp\u003c/a\u003e\u003c/cite\u003e\n\n年表たのしいでよ。","date":1482891904000,"tag":["つくったもの","技術系"]}},"__N_SSG":true},"page":"/entry/[...slug]","query":{"slug":["2016","12","28","Riot_x_Firebaseで作る、超お手軽なパスワード不要のログイン"]},"buildId":"4vVtrTBQuk15W6qLTMkec","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-2efeafdb249345ade087.js"></script><script async="" data-next-page="/_app" src="/_next/static/4vVtrTBQuk15W6qLTMkec/pages/_app.js"></script><script async="" data-next-page="/entry/[...slug]" src="/_next/static/4vVtrTBQuk15W6qLTMkec/pages/entry/%5B...slug%5D.js"></script><script src="/_next/static/runtime/webpack-c212667a5f965e81e004.js" async=""></script><script src="/_next/static/chunks/framework.4dd1003cc9c949c7fcd3.js" async=""></script><script src="/_next/static/chunks/91571cffe5955e319562449996bfe57dbd3e0d38.638a41a739461475fef6.js" async=""></script><script src="/_next/static/runtime/main-21a6ccde974ffcb2250f.js" async=""></script><script src="/_next/static/chunks/f00e1974e9e34e095fc8d755f480321b19c7b23c.840c216a28f4aceb35cf.js" async=""></script><script src="/_next/static/chunks/b986732da9185a1f87bded4986a5845469ee7feb.7cfb4410e6422c3e9136.js" async=""></script><script src="/_next/static/4vVtrTBQuk15W6qLTMkec/_buildManifest.js" async=""></script><script src="/_next/static/4vVtrTBQuk15W6qLTMkec/_ssgManifest.js" async=""></script></body></html>