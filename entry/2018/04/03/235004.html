<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-30867542-2"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-30867542-2', {
              page_path: window.location.pathname,
            });
          </script><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1, minimum-scale=1" name="viewport"/><link rel="icon" href="/images/notsobad/favicon.ico"/><meta name="description" content="ぼっちスタートアップが日々がんばっています。"/><meta content="website" property="og:type"/><meta content="NOT SO BADなブログ" property="og:site_name"/><meta content="summary_large_image" name="twitter:card"/><title>Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話</title><meta content="Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話" property="og:title"/><meta content="https://notsobad.jp/blog/2018/04/03/235004" property="og:url"/><link rel="canonical" href="https://blog.notsobad.jp/2018/04/03/235004"/><meta content="https://storage.googleapis.com/blog-notsobad/images/20180403035841.png" property="og:image"/><meta content="https://storage.googleapis.com/blog-notsobad/images/20180403035841.png" name="twitter:image:src"/><meta content="FJUG#3でLTさせてもらってきました！

[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)

前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。

発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。" property="og:description"/><meta content="Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話" name="twitter:title"/><meta content="FJUG#3でLTさせてもらってきました！

[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)

前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。

発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。" name="twitter:description"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/2a61bf5a1a48ba5e812c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2a61bf5a1a48ba5e812c.css"/><link rel="preload" href="/_next/static/4WMxPnToLL1tLub_9wlEF/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/4WMxPnToLL1tLub_9wlEF/pages/entry/%5B...slug%5D.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-c212667a5f965e81e004.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.4dd1003cc9c949c7fcd3.js" as="script"/><link rel="preload" href="/_next/static/chunks/e101166fa47a6f9b499c839ffe7e06d3a068b976.638a41a739461475fef6.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-5655d340547bb835631a.js" as="script"/><link rel="preload" href="/_next/static/chunks/0e5f2ef3bf5e1e230eaa0e1402cbee45f80e14ca.df0200d1732db7c6b1bb.js" as="script"/><link rel="preload" href="/_next/static/chunks/c34625df1ce3899990efa4e4254c5efc0f608d33.7cfb4410e6422c3e9136.js" as="script"/></head><body><div id="__next"><div><section class="text-gray-700 body-font"><div class="container px-5 md:px-24 p-5 md:pb-12 mx-auto max-w-screen-lg"><h1 class="text-xl font-bold title-font text-gray-900 mb-4 inline-block border-b-4 border-gray-900"><a href="/">NOT SO BAD なブログ</a></h1><h2 class="text-xs text-gray-700 tracking-widest font-medium title-font">ぼっちスタートアップが日々がんばっています。</h2></div></section><section class="text-gray-700 body-font overflow-hidden break-all"><div class="container px-5 md:px-24 pb-24 mx-auto max-w-screen-lg"><div class="-my-8"><div class="py-12 flex flex-wrap md:flex-no-wrap"><div class="md:w-64 md:mb-0 mb-6 flex-shrink-0 flex flex-col"><span class="mt-1 text-gray-900 font-bold">2018-04-03</span></div><div class="flex-grow"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 title-font mb-4">Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話</h2><img src="https://storage.googleapis.com/blog-notsobad/images/20180403035841.png" alt="Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話" class="mb-4"/><div id="mainText" class="leading-relaxed"><p class="my-6">FJUG#3でLTさせてもらってきました！</p><p class="my-6"><a href="https://firebase-community.connpass.com/event/80526/" target="_blank" class="text-blue-600 underline">firebase-community.connpass.com</a></p><p class="my-6">前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。</p><p class="my-6">発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。* * *</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">LT内容</h2><p class="my-6"><a href="https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban" target="_blank" class="text-blue-600 underline">https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban</a></p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">3行で要約</h2><ul class="text-left list-disc ml-6"><li class="leading-8">Riot.js/Firebaseでサービスをリニューアルしたら、Googleにインデックスされなくなって困りました</li><li class="leading-8">SSRとか大変なのは避けたかったので、Functionsでmetaタグだけ差し替えたんだけどいいですよね？</li><li class="leading-8">それだけだとクロールされないので、Functionsで超お手軽にRSSフィードとsitemapを配信する方法も試してみましたよ。</li></ul><p class="my-6">一言でいうと、Functions最高ー。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">背景的な話</h2><p class="my-6">このコンテンツは、こちらの記事の追記のような位置付けです。</p><p class="my-6"><a href="http://blog.notsobad.jp/entry/2018/03/31/132507" target="_blank" class="text-blue-600 underline">blog.notsobad.jp</a></p><p class="my-6">サイトリニューアルで出てきたSEO問題を、できるだけ楽して解決できないかとがんばった記録になっております。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">エクスキューズ</h2><p class="my-6">これでいいんじゃないですかとか適当なこと言ってますが、会社でこんなことしてたら怒られるかもしれないので気をつけてください。</p><blockquote><p class="my-6">「SSRまではいらないけど、ある程度metaを動的にコントロールしたい」っていう欲求は結構理解できる。特に趣味プロでバックにfirebase 、みたいなシチュと割と相性良さそうなイメージだ <a href="https://twitter.com/hashtag/fjug?src=hash&amp;ref_src=twsrc%5Etfw" target="_blank" class="text-blue-600 underline">#fjug</a></p><p class="my-6">— Yosuke Kurami (@Quramy) <a href="https://twitter.com/Quramy/status/980772868182065152?ref_src=twsrc%5Etfw" target="_blank" class="text-blue-600 underline">2018年4月2日</a></p></blockquote><p class="my-6">温度感としては、@Quramyさんが書いてくださってるのがほんとにその通りって感じじゃないかと。</p><p class="my-6">スライドにも書いてますが、とはいえGoogleBotにちゃんと認識されてるならそもそもこんなことしたくなかったわけで。。</p><p class="my-6">あくまでインデックスされなくて困ってて、でもSSRまでしたくなくて、っていうひとつの事例としてお楽しみください。 （パフォーマンス改善のためにSSR、とかって文脈ではない）</p><p class="my-6">同じようなシチュエーションの人の助けになればうれしいです。</p><hr/><p class="my-6">以下、やったこと３つをそれぞれ少しだけ追加説明していきます。</p><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">① Functionsでmetaタグだけレンダリング</h2><p class="my-6">要するに、SPAでエンドポイントになるindex.htmlをそのまま返すんじゃなくて、functionsをかませてmetaタグだけ書き換えてから返すという、SMR（Serverside Metatag Rendering）です。聞いたことないけど。</p><p class="my-6">けっこう探しても事例がなくて不安だったんですが、Lambdaでやってるという話を聞くと安心感があります。</p><blockquote><p class="my-6">同じようなコンテキストでAWS Lambdaで動的にmetaレンダリングしてます、みたいな話を以前に聞いたことあるし、function 利用してmetaもそんなに悪手では無い気と思ってる <a href="https://twitter.com/hashtag/fjug?src=hash&amp;ref_src=twsrc%5Etfw" target="_blank" class="text-blue-600 underline">#fjug</a></p><p class="my-6">— Yosuke Kurami (@Quramy) <a href="https://twitter.com/Quramy/status/980772075513176064?ref_src=twsrc%5Etfw" target="_blank" class="text-blue-600 underline">2018年4月2日</a></p></blockquote><p class="my-6">全体的に@Quramyさんのコメントに救われてる。。</p><p class="my-6">このやり方で懸念になるのはFunctionsの使用量とパフォーマンスなわけですが、FunctionsのレスポンスはCDNにキャッシュできるというのが、意外と知られていなかったりしますよね（ぼくが知らなかっただけですがw）</p><p class="my-6"><a href="https://firebase.google.com/docs/hosting/functions?hl=ja#managing_cache_behavior" target="_blank" class="text-blue-600 underline">Cloud Functions による動的コンテンツの配信  |  Firebase</a></p><p class="my-6">CDNから返してくれればFunctionsはトリガーされずに済むので、アクセスが増えてもそこまで使用量は増えない、はず。</p><p class="my-6">とはいえまだ実運用で大量のアクセスさばいて大丈夫でした、という経験があるわけではないので、ご利用は自己責任でお願いします。 blazeプランは料金上限を設定できないって、結構こわいですね。</p><hr/><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">② Functionsでお手軽RSSフィード配信</h2><p class="my-6">metaタグレンダリングでbotに認識されるようになりましたが、クロールしてもらえないと意味がありません。 というわけでRSSフィードとsitemapを極小労力で用意してみます。</p><p class="my-6">まずはRSSフィードですが、これもFunctionsを使って、/feedにアクセスが来たらfirestoreから最新のデータを取ってXMLで返すようにしました。</p><p class="my-6">簡単すぎて、node-rssが便利だったことくらいしか特に言うことがない。。</p><p class="my-6">しかし猛烈にお手軽なので、とりあえずやっといて損はないんじゃないでしょうか。 これこそ更新は1日数回でいいと思うので、長めにキャッシュして節約したいところです。</p><hr/><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">③ スプレッドシートでお手軽sitemap配信</h2><p class="my-6">最後にsitemapの作成。たぶん過去最高に頭わるそうなsitemapのハックです。</p><p class="my-6">ということは、スプレッドシートにURL一覧作ってCSV形式で公開すると、それがvalidなsitemapのURLになってしまうと。</p><p class="my-6">さらに更新は、さっきのRSSのフィード更新をトリガーに、IFTTTでシートに自動追記。 ついにコードを1行も書くことすらなく、自動更新されるsitemapをお手軽に作ることができました。</p><p class="my-6">sitemapの管理って地味にめんどくさいので、ミニマムでやるなら意外とおすすめです。 機会があればぜひ試してみてください。</p><hr/><h2 class="font-bold inline-block my-4 md:my-8 text-2xl">まとめ</h2><p class="my-6">という感じでLTをしてきたのですが、調べて実装終えたのが発表ぎりぎりだったので、結果の検証までできてませんでした。</p><p class="my-6">実装から数日経ってどうなったかというと、、</p><p class="my-6"><img alt="f:id:o_tomomichi:20180403185752p:plain" title="f:id:o_tomomichi:20180403185752p:plain" src="https://cdn-ak.f.st-hatena.com/images/fotolife/o/o_tomomichi/20180403/20180403185752.png"/></p><p class="my-6"><img alt="f:id:o_tomomichi:20180403185803p:plain" title="f:id:o_tomomichi:20180403185803p:plain" src="https://cdn-ak.f.st-hatena.com/images/fotolife/o/o_tomomichi/20180403/20180403185803.png"/></p><p class="my-6">いい感じ。</p><p class="my-6">もちろんfunctionsも無料枠で収まるペースです。よかったよかった。</p></div></div></div></div></div></section><footer class="text-gray-200 body-font"><div class="bg-gray-900"><div class="container mx-auto py-6 px-5 md:px-24 flex flex-wrap flex-col sm:flex-row max-w-screen-lg"><p class="text-gray-200 text-sm text-center sm:text-left"><a class="text-gray-500 hover:text-gray-200 ml-1" href="/">© 2020 NOT SO BADなブログ</a></p></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"title":"Riot.jsでSPAにしたらGoogleにインデックスされなくなったので、FirebaseのFunctionsでmetaタグだけレンダリングした話","slug":"2018/04/03/235004","excerpt":"FJUG#3でLTさせてもらってきました！\n\n[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。","content":"FJUG#3でLTさせてもらってきました！\n\n[firebase-community.connpass.com](https://firebase-community.connpass.com/event/80526/)\n\n前回#2に続いての参加で、今回は思い切ってLT枠に突っ込ませてもらいました。 150人の前でのLTは初めてでしたが、緊張で死ぬかと思いました。\n\n発表したスライドにちょっとした説明やその後の検証結果を追記して、ブログに残しておこうと思います。* * *\n\nLT内容\n----\n\n[https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban](https://speakerdeck.com/tomomichi/ogpdui-ying-moukoreteiinsiyanaitesuka2018zan-ding-ban)\n\n3行で要約\n-----\n\n*   Riot.js/Firebaseでサービスをリニューアルしたら、Googleにインデックスされなくなって困りました\n*   SSRとか大変なのは避けたかったので、Functionsでmetaタグだけ差し替えたんだけどいいですよね？\n*   それだけだとクロールされないので、Functionsで超お手軽にRSSフィードとsitemapを配信する方法も試してみましたよ。\n\n一言でいうと、Functions最高ー。\n\n背景的な話\n-----\n\nこのコンテンツは、こちらの記事の追記のような位置付けです。\n\n[blog.notsobad.jp](http://blog.notsobad.jp/entry/2018/03/31/132507)\n\nサイトリニューアルで出てきたSEO問題を、できるだけ楽して解決できないかとがんばった記録になっております。\n\nエクスキューズ\n-------\n\nこれでいいんじゃないですかとか適当なこと言ってますが、会社でこんなことしてたら怒られるかもしれないので気をつけてください。\n\n\u003e 「SSRまではいらないけど、ある程度metaを動的にコントロールしたい」っていう欲求は結構理解できる。特に趣味プロでバックにfirebase 、みたいなシチュと割と相性良さそうなイメージだ [#fjug](https://twitter.com/hashtag/fjug?src=hash\u0026ref_src=twsrc%5Etfw)\n\u003e \n\u003e — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772868182065152?ref_src=twsrc%5Etfw)\n\n温度感としては、@Quramyさんが書いてくださってるのがほんとにその通りって感じじゃないかと。\n\nスライドにも書いてますが、とはいえGoogleBotにちゃんと認識されてるならそもそもこんなことしたくなかったわけで。。\n\nあくまでインデックスされなくて困ってて、でもSSRまでしたくなくて、っていうひとつの事例としてお楽しみください。 （パフォーマンス改善のためにSSR、とかって文脈ではない）\n\n同じようなシチュエーションの人の助けになればうれしいです。\n\n* * *\n\n以下、やったこと３つをそれぞれ少しだけ追加説明していきます。\n\n① Functionsでmetaタグだけレンダリング\n--------------------------\n\n要するに、SPAでエンドポイントになるindex.htmlをそのまま返すんじゃなくて、functionsをかませてmetaタグだけ書き換えてから返すという、SMR（Serverside Metatag Rendering）です。聞いたことないけど。\n\nけっこう探しても事例がなくて不安だったんですが、Lambdaでやってるという話を聞くと安心感があります。\n\n\u003e 同じようなコンテキストでAWS Lambdaで動的にmetaレンダリングしてます、みたいな話を以前に聞いたことあるし、function 利用してmetaもそんなに悪手では無い気と思ってる [#fjug](https://twitter.com/hashtag/fjug?src=hash\u0026ref_src=twsrc%5Etfw)\n\u003e \n\u003e — Yosuke Kurami (@Quramy) [2018年4月2日](https://twitter.com/Quramy/status/980772075513176064?ref_src=twsrc%5Etfw)\n\n全体的に@Quramyさんのコメントに救われてる。。\n\nこのやり方で懸念になるのはFunctionsの使用量とパフォーマンスなわけですが、FunctionsのレスポンスはCDNにキャッシュできるというのが、意外と知られていなかったりしますよね（ぼくが知らなかっただけですがw）\n\n[Cloud Functions による動的コンテンツの配信  |  Firebase](https://firebase.google.com/docs/hosting/functions?hl=ja#managing_cache_behavior)\n\nCDNから返してくれればFunctionsはトリガーされずに済むので、アクセスが増えてもそこまで使用量は増えない、はず。\n\nとはいえまだ実運用で大量のアクセスさばいて大丈夫でした、という経験があるわけではないので、ご利用は自己責任でお願いします。 blazeプランは料金上限を設定できないって、結構こわいですね。\n\n* * *\n\n② Functionsでお手軽RSSフィード配信\n------------------------\n\nmetaタグレンダリングでbotに認識されるようになりましたが、クロールしてもらえないと意味がありません。 というわけでRSSフィードとsitemapを極小労力で用意してみます。\n\nまずはRSSフィードですが、これもFunctionsを使って、/feedにアクセスが来たらfirestoreから最新のデータを取ってXMLで返すようにしました。\n\n簡単すぎて、node-rssが便利だったことくらいしか特に言うことがない。。\n\nしかし猛烈にお手軽なので、とりあえずやっといて損はないんじゃないでしょうか。 これこそ更新は1日数回でいいと思うので、長めにキャッシュして節約したいところです。\n\n* * *\n\n③ スプレッドシートでお手軽sitemap配信\n-----------------------\n\n最後にsitemapの作成。たぶん過去最高に頭わるそうなsitemapのハックです。\n\n![f:id:o_tomomichi:20180403184508p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/o/o_tomomichi/20180403/20180403184508.png \"f:id:o_tomomichi:20180403184508p:plain\")\n\nということは、スプレッドシートにURL一覧作ってCSV形式で公開すると、それがvalidなsitemapのURLになってしまうと。\n\nさらに更新は、さっきのRSSのフィード更新をトリガーに、IFTTTでシートに自動追記。 ついにコードを1行も書くことすらなく、自動更新されるsitemapをお手軽に作ることができました。\n\nsitemapの管理って地味にめんどくさいので、ミニマムでやるなら意外とおすすめです。 機会があればぜひ試してみてください。\n\n* * *\n\nまとめ\n---\n\nという感じでLTをしてきたのですが、調べて実装終えたのが発表ぎりぎりだったので、結果の検証までできてませんでした。\n\n実装から数日経ってどうなったかというと、、\n\n![f:id:o_tomomichi:20180403185752p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/o/o_tomomichi/20180403/20180403185752.png \"f:id:o_tomomichi:20180403185752p:plain\")\n\n![f:id:o_tomomichi:20180403185803p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/o/o_tomomichi/20180403/20180403185803.png \"f:id:o_tomomichi:20180403185803p:plain\")\n\nいい感じ。\n\nもちろんfunctionsも無料枠で収まるペースです。よかったよかった。","date":1522767004000,"image":"https://storage.googleapis.com/blog-notsobad/images/20180403035841.png"}},"__N_SSG":true},"page":"/entry/[...slug]","query":{"slug":["2018","04","03","235004"]},"buildId":"4WMxPnToLL1tLub_9wlEF","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-f1eec38e83a82f41790c.js"></script><script async="" data-next-page="/_app" src="/_next/static/4WMxPnToLL1tLub_9wlEF/pages/_app.js"></script><script async="" data-next-page="/entry/[...slug]" src="/_next/static/4WMxPnToLL1tLub_9wlEF/pages/entry/%5B...slug%5D.js"></script><script src="/_next/static/runtime/webpack-c212667a5f965e81e004.js" async=""></script><script src="/_next/static/chunks/framework.4dd1003cc9c949c7fcd3.js" async=""></script><script src="/_next/static/chunks/e101166fa47a6f9b499c839ffe7e06d3a068b976.638a41a739461475fef6.js" async=""></script><script src="/_next/static/runtime/main-5655d340547bb835631a.js" async=""></script><script src="/_next/static/chunks/0e5f2ef3bf5e1e230eaa0e1402cbee45f80e14ca.df0200d1732db7c6b1bb.js" async=""></script><script src="/_next/static/chunks/c34625df1ce3899990efa4e4254c5efc0f608d33.7cfb4410e6422c3e9136.js" async=""></script><script src="/_next/static/4WMxPnToLL1tLub_9wlEF/_buildManifest.js" async=""></script><script src="/_next/static/4WMxPnToLL1tLub_9wlEF/_ssgManifest.js" async=""></script></body></html>